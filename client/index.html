<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>Virtual Black Rock City</title>
		<style>
			:root{
				--bg-x: 0;
				--bg-y: 0;
			}
			*{
				margin:0;
				padding:0;
			}
			html,body{
				width: 100%;
				height: 100%;
			}
			body::after{
				content: 'connecting...';
			}
			body.connected::after{
				display: none;
			}
			body.connected #players{
				width: 100%;
				height: 100%;
				background: url(/assets/brc.svg) no-repeat center;
				background-size: 400%;
				background-position: calc(var(--bg-x) * 1%) calc(var(--bg-y) * 1%);
			}
			#players>.player{
				width: 0;
				height: 0;
				border-radius: 50%;
				border: 10px solid black;
				background-color: black;
				position: relative;
			}
			#players>.player>.name{
				position: absolute;
				top: -12px;
				transform: translateX(-50%);
			}
			#players>.player>.msg{
				position: absolute;
				top: 12px;
				transform: translateX(-50%);
			}
		</style>
	</head>
	<body>
		<div id="players"></div>
		<script src="/socket.io/socket.io.js"></script>
		<script>
			let self=false;
			let socket=io();
			
			function updatePlayer(p){
				let elem=document.getElementById('player_'+p.id);
				if(elem===null){
					elem=document.createElement('div');
					elem.id='player_'+p.id;
					elem.classList.add('player');
					document.getElementById('players').appendChild(elem);

					let name=document.createElement('div');
					name.classList.add('name');
					elem.appendChild(name);
					
					let msg=document.createElement('div');
					msg.classList.add('msg');
					elem.appendChild(msg);
				}
				if(typeof p.x!='undefined'){
					// there is new position data
					elem.style.left=(p.x-self.x+50)+"%";
					elem.style.top=(p.y-self.y+50)+"%";
				}
				if(typeof p.name!='undefined'){
					// there is a new name
					elem.querySelector('.name').innerText=p.name;
				}
				if(typeof p.msg!='undefined'){
					// there is a new message
					elem.querySelector('.msg').innerText=p.msg;
				}
				
				if(p.id==self.id){
					// own player moved, update viewport
					// TODO update viewport
				}
			}
			
			socket.on('init',(data)=>{
				self.id=data.self;
				console.info('self',self);
				data.players.forEach(updatePlayer);
				document.body.classList.add('connected');
				requestAnimationFrame(adjust_bg);
			});
			
			socket.on('ping',()=>{
				// send all player data
				socket.emit('player',self);
			});

			socket.on('player',updatePlayer);
			
			socket.on('remove',(id)=>{
				document.getElementById('player_'+id).remove();
			});
		</script>
	</body>
</html>